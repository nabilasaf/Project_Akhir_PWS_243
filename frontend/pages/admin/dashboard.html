<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard | GameVault</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../../css/admin.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>

    <div class="layout">

        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">ğŸ‘‘ GameVault Admin</div>

            <nav>
                <a class="active" href="dashboard.html">ğŸ“Š Dashboard</a>
                <a href="users.html">ğŸ‘¥ User Management</a>
                <a href="monitoring.html">ğŸ“ˆ API Monitoring</a>
                <a href="logs.html">ğŸ“‹ System Logs</a>
                <a href="games.html">ğŸ® Game Management</a>
            </nav>

            <div class="logout" id="btn-logout">ğŸšª Logout</div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main">

            <!-- HEADER -->
            <div class="header">
                <div>
                    <h1>Admin Dashboard</h1>
                    <span class="admin-badge">Administrator</span>
                </div>
                <div class="user-profile">
                    <span id="username">Admin</span>
                    <div class="avatar" id="avatar">A</div>
                </div>
            </div>

            <!-- STATS CARDS -->
            <section class="stats">
                <div class="stat-card">
                    <div class="icon">ğŸ‘¥</div>
                    <h3>Total Users</h3>
                    <div class="value" id="total-users">â€“</div>
                    <div class="subtitle">Registered accounts</div>
                </div>

                <div class="stat-card">
                    <div class="icon">ğŸ“Š</div>
                    <h3>Total API Calls</h3>
                    <div class="value" id="total-calls">â€“</div>
                    <div class="subtitle">All time requests</div>
                </div>

                <div class="stat-card">
                    <div class="icon">ğŸ”‘</div>
                    <h3>Active API Keys</h3>
                    <div class="value" id="active-keys">â€“</div>
                    <div class="subtitle">Currently enabled</div>
                </div>

                <div class="stat-card">
                    <div class="icon">ğŸ®</div>
                    <h3>Total Games</h3>
                    <div class="value" id="total-games">â€“</div>
                    <div class="subtitle">In database</div>
                </div>
            </section>

            <!-- CHARTS ROW -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">

                <!-- API USAGE CHART -->
                <div class="chart-container">
                    <h2>ğŸ“ˆ API Usage Trends</h2>
                    <canvas id="usageChart"></canvas>
                </div>

                <!-- USER GROWTH CHART -->
                <div class="chart-container">
                    <h2>ğŸ‘¥ User Growth</h2>
                    <canvas id="userChart"></canvas>
                </div>

            </div>

            <!-- RECENT USERS TABLE -->
            <div class="table-container">
                <h2 style="color: #012952; margin-bottom: 20px; font-size: 20px;">ğŸ‘¥ Recent User Registrations</h2>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recent-users">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="loading">Loading users</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- SYSTEM STATUS -->
            <div class="section">
                <h2>ğŸŒ System Status</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">

                    <div
                        style="padding: 16px; background: #dcfce7; border-radius: 12px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 12px; color: #166534; font-weight: 600; margin-bottom: 4px;">API SERVER
                        </div>
                        <div style="font-size: 18px; font-weight: 700; color: #166534;">âœ“ Operational</div>
                    </div>

                    <div
                        style="padding: 16px; background: #dcfce7; border-radius: 12px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 12px; color: #166534; font-weight: 600; margin-bottom: 4px;">DATABASE
                        </div>
                        <div style="font-size: 18px; font-weight: 700; color: #166534;">âœ“ Connected</div>
                    </div>

                    <div
                        style="padding: 16px; background: #dcfce7; border-radius: 12px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 12px; color: #166534; font-weight: 600; margin-bottom: 4px;">CACHE</div>
                        <div style="font-size: 18px; font-weight: 700; color: #166534;">âœ“ Active</div>
                    </div>

                    <div
                        style="padding: 16px; background: #dcfce7; border-radius: 12px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 12px; color: #166534; font-weight: 600; margin-bottom: 4px;">UPTIME</div>
                        <div style="font-size: 18px; font-weight: 700; color: #166534;" id="uptime">99.9%</div>
                    </div>

                </div>
            </div>

        </main>
    </div>

    <script src="../../js/admin.js"></script>
    <script>
        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadAdminDashboard();
        });

        async function loadAdminDashboard() {
            const token = localStorage.getItem('token');

            try {
                // Load admin stats (you'll need to create this endpoint)
                const response = await fetch('http://localhost:3001/api/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch admin data');

                const data = await response.json();

                // Update stats
                document.getElementById('total-users').textContent = data.totalUsers ?? 0;
                document.getElementById('total-calls').textContent = data.todayRequests ?? 0;
                document.getElementById('active-keys').textContent = data.activeApiKeys ?? 0;
                document.getElementById('total-games').textContent = data.totalGames ?? 0;


                // Render charts
                renderUsageChart(data.usageData || []);
                renderUserChart(data.userData || []);

                // Load recent users
                loadRecentUsers();

            } catch (error) {
                console.error('Error loading admin dashboard:', error);
                // Set placeholder data for demo
                document.getElementById('total-users').textContent = '0';
                document.getElementById('total-calls').textContent = '0';
                document.getElementById('active-keys').textContent = '0';
                document.getElementById('total-games').textContent = '0';
            }
        }

        function renderUsageChart(data) {
            const ctx = document.getElementById('usageChart').getContext('2d');

            // Demo data if no data provided
            const labels = data.length > 0 ? data.map(d => d.date) : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const values = data.length > 0 ? data.map(d => d.count) : [120, 190, 150, 220, 180, 240, 200];

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'API Requests',
                        data: values,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fbbf24',
                        pointBorderColor: '#012952',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#012952', font: { weight: 600 } },
                            grid: { color: 'rgba(1, 41, 82, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#012952', font: { weight: 600 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderUserChart(data) {
            const ctx = document.getElementById('userChart').getContext('2d');

            // Demo data
            const labels = data.length > 0 ? data.map(d => d.date) : ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            const values = data.length > 0 ? data.map(d => d.count) : [5, 12, 8, 15];

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Users',
                        data: values,
                        backgroundColor: 'rgba(251, 191, 36, 0.8)',
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#012952', font: { weight: 600 } },
                            grid: { color: 'rgba(1, 41, 82, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#012952', font: { weight: 600 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function loadRecentUsers() {
            const token = localStorage.getItem('token');
            const tbody = document.getElementById('recent-users');

            try {
                const response = await fetch('http://localhost:3001/api/admin/users?limit=10', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch users');

                const users = await response.json();

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
        <tr>
          <td>#${user.user_id}</td>
          <td>${user.email}</td>
          <td><span class="status-badge ${user.role}">${user.role.toUpperCase()}</span></td>
          <td><span class="status-badge ${user.status || 'active'}">${(user.status || 'active').toUpperCase()}</span></td>
          <td>${new Date(user.created_at).toLocaleDateString()}</td>
          <td>
            <button class="action-btn" onclick="viewUser(${user.user_id})">View</button>
            <button class="action-btn danger" onclick="suspendUser(${user.user_id})">Suspend</button>
          </td>
        </tr>
      `).join('');

            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">Failed to load users</td></tr>';
            }
        }

        function viewUser(userId) {
            window.location.href = `users.html?id=${userId}`;
        }

        function suspendUser(userId) {
            if (confirm('Are you sure you want to suspend this user?')) {
                alert('User suspension feature coming soon!');
            }
        }
    </script>
</body>

</html>